{% extends 'base.html.twig' %}

{% block title %}
	{{ lecon.titre }}
{% endblock %}
{% block body_class %}page-lecon-show
{% endblock %}

{% block body %}
	<main class="container py-4 mt-3">

		<button class="mt-2" onclick="changerMode()" id="modeButton">üåô</button>

		{# ‚úÖ Flash messages   #}
		{% for msg in app.flashes('info') %}
			<div class="alert alert-info d-flex justify-content-between align-items-center">
				<div>{{ msg }}</div>
				<a href="{{ path('connexion') }}" class="btn btn-sm btn-primary">Se connecter</a>
			</div>
		{% endfor %}

		{% for msg in app.flashes('warning') %}
			<div class="alert alert-warning d-flex justify-content-between align-items-center">
				<div>{{ msg }}</div>
				<a href="{{ path('cours_show', {id: lecon.cours.id}) }}" class="btn btn-sm btn-dark">Voir le cours</a>
			</div>
		{% endfor %}

		<nav aria-label="breadcrumb" class="mb-2">
			<ol class="breadcrumb">
				<li class="breadcrumb-item">
					<a class="text-primary" href="{{ path('cours') }}">Tous les cours</a>
				</li>
				<li class="breadcrumb-item">
					<a class="text-primary" href="{{ path('cours_show', {id: lecon.cours.id}) }}">{{ lecon.cours.titre }}</a>
				</li>
				<li class="breadcrumb-item active text-dark" aria-current="page">Le√ßon
					{{ lecon.position }}</li>
			</ol>
		</nav>

		<div class="d-flex justify-content-between align-items-center mb-3">
			<div>
				<h1 class="h4 mb-1">{{ lecon.titre }}</h1>

				{% set total = playlist|length %}
				{% set current = lecon.position %}
				{% set percent = ((current / total) * 100)|round %}

				<div class="mb-3">
					<div class="d-flex justify-content-between small text-secondary mb-1">
						<span class=" text-dark">Progression</span>
						<span class="text-dark">{{ current }}/{{ total }}
							({{ percent }}%)</span>
					</div>

					<div class="progress">
						<div class="progress-bar text-dark" role="progressbar" style="width: {{ percent }}%"></div>
					</div>
				</div>

				<div class="small">
					Le√ßon
					{{ lecon.position }}
					‚Äî
					{{ lecon.cours.titre }}
					{% if lecon.estGratuite %}
						<span class="badge bg-success ms-2">Gratuite</span>
					{% else %}
						<span class="badge bg-secondary ms-2">üîí Premium</span>
					{% endif %}
				</div>
			</div>
		</div>

		<div
			class="row g-4">
			{# ====== LEFT: VIDEO ====== #}
			<div class="col-lg-8">

				{% set url = lecon.videoUrl %}
				{% set embedUrl = url %}

				{% if 'watch?v=' in url %}
					{% set embedUrl = url|replace({'watch?v=': 'embed/'}) %}
				{% endif %}

				{% if 'youtu.be/' in url %}
					{% set embedUrl = url|replace({'youtu.be/': 'www.youtube.com/embed/'}) %}
				{% endif %}

				<div class="card shadow-sm">
					<div class="card-body">
						<div class="ratio ratio-16x9">
							<iframe src="{{ embedUrl }}" title="{{ lecon.titre }}" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>
						</div>
					</div>
				</div>

				<div class="card mt-3 shadow-sm">
					<div class="card-body">
						<h2 class="h5 mb-2 text-dark">Objectif de ce cours</h2>
						<ul class="mb-0 text-dark">
							<li>Comprendre les notions cl√©s li√©es √†
								<strong>{{ lecon.cours.titre }}</strong>
							</li>
							<li>Identifier les composants essentiels et leur r√¥le</li>
							<li>Appliquer les concepts √† un exemple pratique</li>
						</ul>
					</div>

					<div class="card-ressources mt-3 shadow-sm">
						<div class="card-body border-0 d-flex justify-content-between align-items-center flex-wrap gap-2">
							<div>
								<h2 class="h5 mb-1 text-dark">Ressources</h2>
								<div class="small text-dark">Support de cours (PDF)</div>
							</div>

							<a class="button-cours" href="{{ asset('files/113335527-Php.pdf') }}" target="_blank">
								üìÑ T√©l√©charger le support
							</a>
						</div>
					</div>
				</div>

				{# Next/Prev #}
				<div class="d-flex justify-content-between mt-3">
					<div>
						{% if previousLecon %}
							<a class="button-cours" href="{{ path('lecon_show', { id: previousLecon.id }) }}">
								‚¨ÖÔ∏è Pr√©c√©dent
							</a>
						{% endif %}
					</div>

					<div>
						{% if nextLecon %}
							{% if nextLecon.estGratuite or canAccessPremium %}
								<a class="button-cours" href="{{ path('lecon_show', { id: nextLecon.id }) }}">Suivant ‚û°Ô∏è</a>
							{% else %}
								<button class="button-cours" disabled>üîí Suivant</button>
							{% endif %}
						{% endif %}
					</div>
				</div>
			</div>

			{# ====== RIGHT: PLAYLIST ====== #}
			<div class="col-lg-4">
				<div class="card-playlist border-1 shadow-sm">
					<div class="card-header fw-bold">
						Playlist ‚Äî
						{{ lecon.cours.titre }}
					</div>

					<div class="list-group list-group-flush" style="max-height: 520px; overflow:auto;">
						{% set canPremium = canAccessPremium ?? false %}

						{% for item in playlist %}
							{% set isActive = (item.id == lecon.id) %}
							{% set canOpen = item.estGratuite or canPremium %}

							{% if canOpen %}
								<a href="{{ path('lecon_show', { id: item.id }) }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center {% if isActive %} active {% endif %}">
									<span>{{ item.position }}.
										{{ item.titre }}</span>
									<span class="badge bg-light text-dark">‚ñ∂Ô∏è</span>
								</a>
							{% else %}
								<div class="list-group-item d-flex justify-content-between align-items-center {% if isActive %} bg-light {% endif %}">
									<span class="text-muted">{{ item.position }}.
										{{ item.titre }}</span>
									<span class="badge bg-secondary">üîí</span>
								</div>
							{% endif %}
						{% endfor %}
					</div>

				</div>
			</div>
		</div>

	</main>
{% endblock %}
